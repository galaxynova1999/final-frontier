<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack HMR &amp; Vite HMR | Final-Frontier</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/final-frontier/assets/css/0.styles.850a3e21.css" as="style"><link rel="preload" href="/final-frontier/assets/js/app.f9e97b58.js" as="script"><link rel="preload" href="/final-frontier/assets/js/2.b4be2d04.js" as="script"><link rel="preload" href="/final-frontier/assets/js/9.3fb29486.js" as="script"><link rel="prefetch" href="/final-frontier/assets/js/10.f2cddb15.js"><link rel="prefetch" href="/final-frontier/assets/js/100.e4731769.js"><link rel="prefetch" href="/final-frontier/assets/js/101.78cba9e0.js"><link rel="prefetch" href="/final-frontier/assets/js/102.d59121ac.js"><link rel="prefetch" href="/final-frontier/assets/js/103.02f81555.js"><link rel="prefetch" href="/final-frontier/assets/js/104.035808e0.js"><link rel="prefetch" href="/final-frontier/assets/js/105.0d0355e5.js"><link rel="prefetch" href="/final-frontier/assets/js/106.45e731ce.js"><link rel="prefetch" href="/final-frontier/assets/js/107.48dd8215.js"><link rel="prefetch" href="/final-frontier/assets/js/108.43b0c535.js"><link rel="prefetch" href="/final-frontier/assets/js/109.b85a4723.js"><link rel="prefetch" href="/final-frontier/assets/js/11.eedec520.js"><link rel="prefetch" href="/final-frontier/assets/js/110.06b6c2c4.js"><link rel="prefetch" href="/final-frontier/assets/js/111.a1f96c71.js"><link rel="prefetch" href="/final-frontier/assets/js/112.8d818d3d.js"><link rel="prefetch" href="/final-frontier/assets/js/113.489f2816.js"><link rel="prefetch" href="/final-frontier/assets/js/114.005d05ff.js"><link rel="prefetch" href="/final-frontier/assets/js/115.7d0940cb.js"><link rel="prefetch" href="/final-frontier/assets/js/116.66d3013d.js"><link rel="prefetch" href="/final-frontier/assets/js/117.e50f9939.js"><link rel="prefetch" href="/final-frontier/assets/js/118.24154638.js"><link rel="prefetch" href="/final-frontier/assets/js/119.c74b3be1.js"><link rel="prefetch" href="/final-frontier/assets/js/12.4317ec11.js"><link rel="prefetch" href="/final-frontier/assets/js/120.5da2342c.js"><link rel="prefetch" href="/final-frontier/assets/js/121.931dba27.js"><link rel="prefetch" href="/final-frontier/assets/js/122.3e61d86a.js"><link rel="prefetch" href="/final-frontier/assets/js/123.a73c06d0.js"><link rel="prefetch" href="/final-frontier/assets/js/124.f38644ba.js"><link rel="prefetch" href="/final-frontier/assets/js/125.d349b0eb.js"><link rel="prefetch" href="/final-frontier/assets/js/126.37600dd5.js"><link rel="prefetch" href="/final-frontier/assets/js/127.7867b78d.js"><link rel="prefetch" href="/final-frontier/assets/js/128.d25e3580.js"><link rel="prefetch" href="/final-frontier/assets/js/129.2a34bed2.js"><link rel="prefetch" href="/final-frontier/assets/js/13.b38bf636.js"><link rel="prefetch" href="/final-frontier/assets/js/130.bcb7b154.js"><link rel="prefetch" href="/final-frontier/assets/js/131.6695048b.js"><link rel="prefetch" href="/final-frontier/assets/js/132.4c59c0d0.js"><link rel="prefetch" href="/final-frontier/assets/js/133.eb3a3330.js"><link rel="prefetch" href="/final-frontier/assets/js/134.59324c5b.js"><link rel="prefetch" href="/final-frontier/assets/js/135.f24f365a.js"><link rel="prefetch" href="/final-frontier/assets/js/136.0b6132bb.js"><link rel="prefetch" href="/final-frontier/assets/js/137.d4e6ae33.js"><link rel="prefetch" href="/final-frontier/assets/js/138.468881cf.js"><link rel="prefetch" href="/final-frontier/assets/js/139.bc47b208.js"><link rel="prefetch" href="/final-frontier/assets/js/14.c582bb27.js"><link rel="prefetch" href="/final-frontier/assets/js/140.06de75d6.js"><link rel="prefetch" href="/final-frontier/assets/js/141.27e6a871.js"><link rel="prefetch" href="/final-frontier/assets/js/142.d4cbec9d.js"><link rel="prefetch" href="/final-frontier/assets/js/143.80d1f094.js"><link rel="prefetch" href="/final-frontier/assets/js/144.42884138.js"><link rel="prefetch" href="/final-frontier/assets/js/145.3d28f7bf.js"><link rel="prefetch" href="/final-frontier/assets/js/146.956955df.js"><link rel="prefetch" href="/final-frontier/assets/js/147.5dcd9c08.js"><link rel="prefetch" href="/final-frontier/assets/js/148.8b882ec0.js"><link rel="prefetch" href="/final-frontier/assets/js/149.d272ab0e.js"><link rel="prefetch" href="/final-frontier/assets/js/15.330b31b0.js"><link rel="prefetch" href="/final-frontier/assets/js/150.15ab6dea.js"><link rel="prefetch" href="/final-frontier/assets/js/151.0c105344.js"><link rel="prefetch" href="/final-frontier/assets/js/152.c2cd9d79.js"><link rel="prefetch" href="/final-frontier/assets/js/153.e34ca29d.js"><link rel="prefetch" href="/final-frontier/assets/js/154.fcd3a9d8.js"><link rel="prefetch" href="/final-frontier/assets/js/155.58105e90.js"><link rel="prefetch" href="/final-frontier/assets/js/156.aeb03519.js"><link rel="prefetch" href="/final-frontier/assets/js/157.b0ccce6e.js"><link rel="prefetch" href="/final-frontier/assets/js/158.bec5b99a.js"><link rel="prefetch" href="/final-frontier/assets/js/159.e81bab43.js"><link rel="prefetch" href="/final-frontier/assets/js/16.4d098475.js"><link rel="prefetch" href="/final-frontier/assets/js/160.02c170a3.js"><link rel="prefetch" href="/final-frontier/assets/js/161.02928332.js"><link rel="prefetch" href="/final-frontier/assets/js/162.52952c0e.js"><link rel="prefetch" href="/final-frontier/assets/js/163.f107f5b9.js"><link rel="prefetch" href="/final-frontier/assets/js/164.4c8ec94f.js"><link rel="prefetch" href="/final-frontier/assets/js/165.fe3f3e38.js"><link rel="prefetch" href="/final-frontier/assets/js/166.bfd94322.js"><link rel="prefetch" href="/final-frontier/assets/js/167.2b012733.js"><link rel="prefetch" href="/final-frontier/assets/js/168.4620404b.js"><link rel="prefetch" href="/final-frontier/assets/js/169.9c928ecb.js"><link rel="prefetch" href="/final-frontier/assets/js/17.65263330.js"><link rel="prefetch" href="/final-frontier/assets/js/170.9df651d4.js"><link rel="prefetch" href="/final-frontier/assets/js/18.b27e1f22.js"><link rel="prefetch" href="/final-frontier/assets/js/19.1ee342e5.js"><link rel="prefetch" href="/final-frontier/assets/js/20.823c015f.js"><link rel="prefetch" href="/final-frontier/assets/js/21.44689c5c.js"><link rel="prefetch" href="/final-frontier/assets/js/22.d030504c.js"><link rel="prefetch" href="/final-frontier/assets/js/23.ebb1757e.js"><link rel="prefetch" href="/final-frontier/assets/js/24.da0e3906.js"><link rel="prefetch" href="/final-frontier/assets/js/25.6ef453f7.js"><link rel="prefetch" href="/final-frontier/assets/js/26.1d8e80db.js"><link rel="prefetch" href="/final-frontier/assets/js/27.5f9099ad.js"><link rel="prefetch" href="/final-frontier/assets/js/28.0a85d87c.js"><link rel="prefetch" href="/final-frontier/assets/js/29.93858a71.js"><link rel="prefetch" href="/final-frontier/assets/js/3.e184c9a6.js"><link rel="prefetch" href="/final-frontier/assets/js/30.b00438fd.js"><link rel="prefetch" href="/final-frontier/assets/js/31.3c252603.js"><link rel="prefetch" href="/final-frontier/assets/js/32.68354049.js"><link rel="prefetch" href="/final-frontier/assets/js/33.edf9c033.js"><link rel="prefetch" href="/final-frontier/assets/js/34.a457093b.js"><link rel="prefetch" href="/final-frontier/assets/js/35.39acde3d.js"><link rel="prefetch" href="/final-frontier/assets/js/36.dc8d1a55.js"><link rel="prefetch" href="/final-frontier/assets/js/37.7f171371.js"><link rel="prefetch" href="/final-frontier/assets/js/38.e98d1f3a.js"><link rel="prefetch" href="/final-frontier/assets/js/39.4e54cadb.js"><link rel="prefetch" href="/final-frontier/assets/js/4.c6e69f90.js"><link rel="prefetch" href="/final-frontier/assets/js/40.573fbcba.js"><link rel="prefetch" href="/final-frontier/assets/js/41.20af0cb8.js"><link rel="prefetch" href="/final-frontier/assets/js/42.733c8990.js"><link rel="prefetch" href="/final-frontier/assets/js/43.32a46e23.js"><link rel="prefetch" href="/final-frontier/assets/js/44.4281f6ab.js"><link rel="prefetch" href="/final-frontier/assets/js/45.d5d2942f.js"><link rel="prefetch" href="/final-frontier/assets/js/46.fc9e248d.js"><link rel="prefetch" href="/final-frontier/assets/js/47.bc3e46b1.js"><link rel="prefetch" href="/final-frontier/assets/js/48.7f953d4b.js"><link rel="prefetch" href="/final-frontier/assets/js/49.c882d8d3.js"><link rel="prefetch" href="/final-frontier/assets/js/5.f65c0638.js"><link rel="prefetch" href="/final-frontier/assets/js/50.79b01142.js"><link rel="prefetch" href="/final-frontier/assets/js/51.4eb54394.js"><link rel="prefetch" href="/final-frontier/assets/js/52.78f38161.js"><link rel="prefetch" href="/final-frontier/assets/js/53.d9389fdd.js"><link rel="prefetch" href="/final-frontier/assets/js/54.d45e0f4d.js"><link rel="prefetch" href="/final-frontier/assets/js/55.9afe2316.js"><link rel="prefetch" href="/final-frontier/assets/js/56.14719107.js"><link rel="prefetch" href="/final-frontier/assets/js/57.585a0866.js"><link rel="prefetch" href="/final-frontier/assets/js/58.5530bfeb.js"><link rel="prefetch" href="/final-frontier/assets/js/59.7f433e63.js"><link rel="prefetch" href="/final-frontier/assets/js/6.4a41c59e.js"><link rel="prefetch" href="/final-frontier/assets/js/60.1e44d3c6.js"><link rel="prefetch" href="/final-frontier/assets/js/61.cdf1979f.js"><link rel="prefetch" href="/final-frontier/assets/js/62.744fc902.js"><link rel="prefetch" href="/final-frontier/assets/js/63.35920e83.js"><link rel="prefetch" href="/final-frontier/assets/js/64.cc6f3dc2.js"><link rel="prefetch" href="/final-frontier/assets/js/65.14df1fc8.js"><link rel="prefetch" href="/final-frontier/assets/js/66.936a2159.js"><link rel="prefetch" href="/final-frontier/assets/js/67.1308bd29.js"><link rel="prefetch" href="/final-frontier/assets/js/68.475e96a8.js"><link rel="prefetch" href="/final-frontier/assets/js/69.74434bff.js"><link rel="prefetch" href="/final-frontier/assets/js/7.784a80c1.js"><link rel="prefetch" href="/final-frontier/assets/js/70.822ecc05.js"><link rel="prefetch" href="/final-frontier/assets/js/71.9c374dcb.js"><link rel="prefetch" href="/final-frontier/assets/js/72.1f0842c9.js"><link rel="prefetch" href="/final-frontier/assets/js/73.8bbca6c1.js"><link rel="prefetch" href="/final-frontier/assets/js/74.17fd08b7.js"><link rel="prefetch" href="/final-frontier/assets/js/75.e39ed91c.js"><link rel="prefetch" href="/final-frontier/assets/js/76.4001f797.js"><link rel="prefetch" href="/final-frontier/assets/js/77.9e146f0f.js"><link rel="prefetch" href="/final-frontier/assets/js/78.77f819d1.js"><link rel="prefetch" href="/final-frontier/assets/js/79.f374ec2e.js"><link rel="prefetch" href="/final-frontier/assets/js/8.c38ccaff.js"><link rel="prefetch" href="/final-frontier/assets/js/80.cb5fd22c.js"><link rel="prefetch" href="/final-frontier/assets/js/81.58ced288.js"><link rel="prefetch" href="/final-frontier/assets/js/82.2a0c8dd8.js"><link rel="prefetch" href="/final-frontier/assets/js/83.62e28c48.js"><link rel="prefetch" href="/final-frontier/assets/js/84.1ffe1d78.js"><link rel="prefetch" href="/final-frontier/assets/js/85.b4311925.js"><link rel="prefetch" href="/final-frontier/assets/js/86.6c39539a.js"><link rel="prefetch" href="/final-frontier/assets/js/87.74481597.js"><link rel="prefetch" href="/final-frontier/assets/js/88.1260b237.js"><link rel="prefetch" href="/final-frontier/assets/js/89.5d5f16bc.js"><link rel="prefetch" href="/final-frontier/assets/js/90.602550f2.js"><link rel="prefetch" href="/final-frontier/assets/js/91.9b50d9db.js"><link rel="prefetch" href="/final-frontier/assets/js/92.9aa7bfa4.js"><link rel="prefetch" href="/final-frontier/assets/js/93.0e8e6805.js"><link rel="prefetch" href="/final-frontier/assets/js/94.bfb47c06.js"><link rel="prefetch" href="/final-frontier/assets/js/95.b5b1f0d3.js"><link rel="prefetch" href="/final-frontier/assets/js/96.6305c39b.js"><link rel="prefetch" href="/final-frontier/assets/js/97.0bd16536.js"><link rel="prefetch" href="/final-frontier/assets/js/98.7da6c33c.js"><link rel="prefetch" href="/final-frontier/assets/js/99.fcdf9b89.js">
    <link rel="stylesheet" href="/final-frontier/assets/css/0.styles.850a3e21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/final-frontier/" class="home-link router-link-active"><img src="/final-frontier/favicon.png" alt="Final-Frontier" class="logo"> <span class="site-name can-hide">Final-Frontier</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/final-frontier/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/final-frontier/article/framework/angular-di.html" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="/final-frontier/basic/js/implement-tool-func.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><a href="/final-frontier/algorithm/leetcode/add-two-numbers.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/final-frontier/notes/professional-js-for-web-developers/type-conversion.html" class="nav-link">
  读书笔记
</a></div> <a href="https://github.com/galaxynova1999/final-frontier" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/final-frontier/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/final-frontier/article/framework/angular-di.html" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="/final-frontier/basic/js/implement-tool-func.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><a href="/final-frontier/algorithm/leetcode/add-two-numbers.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/final-frontier/notes/professional-js-for-web-developers/type-conversion.html" class="nav-link">
  读书笔记
</a></div> <a href="https://github.com/galaxynova1999/final-frontier" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端框架 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/framework/angular-di.html" class="sidebar-link">Angular中的DI</a></li><li><a href="/final-frontier/article/framework/react-performance.html" class="sidebar-link">React性能优化的一点看法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS &amp; TS (5)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/js/arrow-function.html" class="sidebar-link">箭头函数和普通函数的区别</a></li><li><a href="/final-frontier/article/js/does-js-need-semicolon.html" class="sidebar-link">JS 需要使用分号吗?</a></li><li><a href="/final-frontier/article/js/implement-promise.html" class="sidebar-link">实现一个 Promise</a></li><li><a href="/final-frontier/article/js/mutex-atomics.html" class="sidebar-link">使用 Atomics API 实现互斥锁</a></li><li><a href="/final-frontier/article/js/nullish-coalescing-operator.html" class="sidebar-link">空值合并运算符</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程化 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/engineering/tsconfig.html" class="sidebar-link">tsconfig 文件配置</a></li><li><a href="/final-frontier/article/engineering/webpack-config.html" class="sidebar-link">Webpack 基本配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术扩展 (3)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/tech/bitmask.html" class="sidebar-link">位掩码</a></li><li><a href="/final-frontier/article/tech/nrt-yata.html" class="sidebar-link">协同编辑-YATA算法</a></li><li><a href="/final-frontier/article/tech/swagger-ts.html" class="sidebar-link">Swagger 生成 TS 定义文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/browser/browser-cache.html" class="sidebar-link">浅谈浏览器缓存</a></li><li><a href="/final-frontier/article/browser/browser-navigation-timing.html" class="sidebar-link">浏览器Navigation Timing API</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/careteenL/webpack-hmr" target="_blank" rel="noopener noreferrer">参考文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在原文基础上有删改</p></div> <p></p><div class="table-of-contents"><ul><li><a href="#hmr是什么">HMR是什么</a><ul><li><a href="#使用场景">使用场景</a></li></ul></li><li><a href="#在webpack中使用hmr">在Webpack中使用HMR</a><ul><li><a href="#配置webpack">配置webpack</a></li><li><a href="#解析webpack打包后的文件内容-dist">解析Webpack打包后的文件内容('./dist')</a></li><li><a href="#配置hmr">配置HMR</a></li></ul></li><li><a href="#hmr原理">HMR原理</a></li><li><a href="#服务端实现细节">服务端实现细节</a><ul><li><a href="#服务端简易实现">服务端简易实现</a></li></ul></li><li><a href="#客户端实现细节">客户端实现细节</a><ul><li><a href="#客户端简易实现">客户端简易实现</a></li></ul></li><li><a href="#vite中的hmr">Vite中的HMR</a></li><li><a href="#问题">问题</a></li></ul></div><p></p> <h2 id="hmr是什么"><a href="#hmr是什么" class="header-anchor">#</a> HMR是什么</h2> <p><code>HMR</code>即<code>热模块重载、热模块替换(Hot Module Replacement)</code>是指当你对代码修改并保存后，<code>webpack</code>将会对代码进行重新打包，并将改动的模块发送到浏览器端，浏览器用新的模块<strong>替换</strong>掉旧的模块，去实现局部更新页面而非整体刷新页面。</p> <h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <p>一个注册页面包含<code>用户名</code>、<code>密码</code>、<code>邮箱</code>三个必填输入框，以及一个<code>提交</code>按钮，
当你在调试<code>邮箱</code>模块并改动了代码时，没做任何处理情况下会刷新整个页面，频繁的改动代码会浪费你大量时间去重新填写内容。<br>
预期是保留<code>用户名</code>、<code>密码</code>的输入内容，而只替换<code>邮箱</code>这一模块。这一诉求就需要借助<code>webpack-dev-server</code>的热模块更新功能。</p> <p>相对于<code>live reload</code>整体刷新页面的方案，<code>HMR</code>的优点在于可以保存应用的状态，提高开发效率。</p> <h2 id="在webpack中使用hmr"><a href="#在webpack中使用hmr" class="header-anchor">#</a> 在Webpack中使用HMR</h2> <h3 id="配置webpack"><a href="#配置webpack" class="header-anchor">#</a> 配置webpack</h3> <p>首先借助<code>webpack</code>搭建项目</p> <ul><li>初识化项目并导入依赖</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> webpack-hmr <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> webpack-hmr
<span class="token function">npm</span> i -y
<span class="token function">npm</span> i -S webpack webpack-cli webpack-dev-server html-webpack-plugin
</code></pre></div><ul><li>配置文件<code>webpack.config.js</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> htmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 开发模式不压缩代码，方便调试</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span> <span class="token comment">// 入口文件</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'main.js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">contentBase</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">htmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>新建<code>src/index.js</code>入口文件编写简单逻辑</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  root<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./content.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>新建依赖文件<code>src/content.js</code>导出字符供index渲染页面</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token string">'Hello Webpack Hot Module Replacement'</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ret
<span class="token comment">// export default ret</span>
</code></pre></div><ul><li>配置<code>package.json</code></li></ul> <div class="language-json extra-class"><pre class="language-json"><code>  <span class="token property">&quot;scripts&quot;</span> <span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack-dev-server&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack&quot;</span>
  <span class="token punctuation">}</span>
</code></pre></div><ul><li><p>然后<code>npm run dev</code>即可启动项目</p></li> <li><p>通过<code>npm run build</code>打包生成静态资源到<code>dist</code>目录</p></li></ul> <h3 id="解析webpack打包后的文件内容-dist"><a href="#解析webpack打包后的文件内容-dist" class="header-anchor">#</a> 解析Webpack打包后的文件内容('./dist')</h3> <ul><li>Webpack自己实现的一套CommonJs规范讲解</li></ul> <p>dist目录结构</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">.</span>
├── index.html
└── main.js
</code></pre></div><h4 id="其中index-html内容如下"><a href="#其中index-html内容如下" class="header-anchor">#</a> 其中<code>index.html</code>内容如下</h4> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- ... --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- ... --&gt;</span>
</code></pre></div><p>使用<code>html-webpack-plugin</code>插件将入口文件及其依赖通过<code>script</code>标签引入</p> <h4 id="先对main-js内容去掉注释和无关内容进行分析"><a href="#先对main-js内容去掉注释和无关内容进行分析" class="header-anchor">#</a> 先对<code>main.js</code>内容去掉注释和无关内容进行分析</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// webpackBootStrap 一个巨大的自执行函数</span>
   <span class="token comment">// 依赖的模块对象 可能会很巨大  </span>
  <span class="token comment">// 键为入口文件或依赖文件相对于根目录的相对路径，值则是另一个自执行函数执行后的结果，其中使用`eval`执行文件的内容字符。  </span>
  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;./src/content.js&quot;</span><span class="token operator">:</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;var ret = 'Hello Webpack Hot Module Replacement'\n\nmodule.exports = ret\n// export default ret\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 代码中的require变成了 __webpack_require__ 自定义函数</span>
    <span class="token string-property property">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;var root = document.getElementById('root')\nfunction render () {\n  root.innerHTML = __webpack_require__(/*! ./content.js */ \&quot;./src/content.js\&quot;)\n}\nrender()\n\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ....</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>接下来是核心的__webpack_require__ 函数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...__webpack_modules__ ...</span>
    <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 检查模块是否在缓存中</span>
		<span class="token keyword">var</span> cachedModule <span class="token operator">=</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
 		<span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 			<span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule<span class="token punctuation">.</span>error <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> cachedModule<span class="token punctuation">.</span>error<span class="token punctuation">;</span>
 			<span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
 		<span class="token punctuation">}</span>
 		<span class="token comment">// 创建一个module 并且放入缓存中</span>
 		<span class="token keyword">var</span> module <span class="token operator">=</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
 			<span class="token literal-property property">id</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
 			<span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 标识是否加载</span>
 			<span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 		<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行模块函数</span>
      <span class="token comment">/**
       *  module: 传入的module对象
       *  moduleId: 如 '/src/index.js'
       * */</span>
    <span class="token comment">// 执行模块函数</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> execOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span> <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span> <span class="token literal-property property">factory</span><span class="token operator">:</span> __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">require</span><span class="token operator">:</span> __webpack_require__ <span class="token punctuation">}</span><span class="token punctuation">;</span>
      __webpack_require__<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">handler</span><span class="token punctuation">(</span>execOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      module <span class="token operator">=</span> execOptions<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
      execOptions<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> execOptions<span class="token punctuation">.</span>require<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       module<span class="token punctuation">.</span>error <span class="token operator">=</span> e<span class="token punctuation">;</span>
       <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 标识该模块已经被加载</span>
    module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回模块的exports</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 暴露模块对象 (__webpack_modules__)</span>
  	__webpack_require__<span class="token punctuation">.</span>m <span class="token operator">=</span> __webpack_modules__<span class="token punctuation">;</span>
 <span class="token comment">// 暴露模块缓存</span>
    __webpack_require__<span class="token punctuation">.</span>c <span class="token operator">=</span> __webpack_module_cache__<span class="token punctuation">;</span>
 <span class="token comment">// 暴露模块执行拦截器</span>
    __webpack_require__<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ...</span>
  <span class="token comment">// 加载入口文件</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="配置hmr"><a href="#配置hmr" class="header-anchor">#</a> 配置HMR</h3> <p>接下来配置并感受一下热更新带来的便捷开发</p> <p><code>webpack.config.js</code>配置</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// ...</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
</code></pre></div><p><code>./src/index.js</code>配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./content.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当更改<code>./content.js</code>的内容并保存时，可以看到页面没有刷新，但是内容已经被替换了。</p> <h2 id="hmr原理"><a href="#hmr原理" class="header-anchor">#</a> HMR原理</h2> <p><img src="/final-frontier/assets/img/webpack-hmr-1.98bca55f.png" alt="HMR原理">
如上图所示，右侧<code>Server</code>端使用<code>webpack-dev-server</code>去启动本地服务，内部实现主要使用了<code>webpack</code>、<code>express</code>、<code>websocket</code>。</p> <ul><li>使用<code>express</code>启动本地HTTP服务，响应浏览器访问资源的请求</li> <li>服务端和客户端使用<code>websocket</code>实现长连接</li> <li><code>webpack</code>监听源文件的变化，即当开发者保存文件时触发<code>webpack</code>的重新编译。
<ul><li>每次编译都会生成<code>hash值</code>、<code>已改动模块的json文件</code>、<code>已改动模块代码的js文件</code></li> <li>编译完成后通过<code>websocket</code>向客户端推送当前编译的<code>hash戳</code></li></ul></li> <li>客户端的<code>websocket</code>监听到有文件改动推送过来的<code>hash戳</code>，会和上一次（缓存的）对比
<ul><li>一致则走缓存</li> <li>不一致则通过<code>ajax</code>和<code>jsonp</code>向服务端获取最新资源</li></ul></li> <li>使用<code>内存文件系统(memory file system)</code>去替换有修改的内容实现局部刷新</li></ul> <h2 id="服务端实现细节"><a href="#服务端实现细节" class="header-anchor">#</a> 服务端实现细节</h2> <p>下面步骤主要是debug服务端源码分析其详细思路，也给出了代码所处的具体位置，感兴趣的可以先行定位到下面的代码处设置断点，然后观察数据的变化情况。也可以先跳过阅读此步骤。**</p> <ol><li>启动<code>webpack-dev-server</code>服务器，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L173" target="_blank" rel="noopener noreferrer">@webpack-dev-server/webpack-dev-server.js#L173<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>创建webpack实例，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L89" target="_blank" rel="noopener noreferrer">@webpack-dev-server/webpack-dev-server.js#L89<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>创建Server服务器，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L107" target="_blank" rel="noopener noreferrer">@webpack-dev-server/webpack-dev-server.js#L107<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>添加webpack的done事件回调，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L122" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L122<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>编译完成向客户端发送消息，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L184" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L184<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>创建express应用app，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L123" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L123<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>设置文件系统为内存文件系统，源代码地址<a href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/lib/fs.js#L115" target="_blank" rel="noopener noreferrer">@webpack-dev-middleware/fs.js#L115<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>添加webpack-dev-middleware中间件，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L125" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L125<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>中间件负责返回生成的文件，源代码地址<a href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/lib/middleware.js#L20" target="_blank" rel="noopener noreferrer">@webpack-dev-middleware/middleware.js#L20<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>启动webpack编译，源代码地址<a href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/index.js#L51" target="_blank" rel="noopener noreferrer">@webpack-dev-middleware/index.js#L51<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>创建http服务器并启动服务，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L135" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L135<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L745" target="_blank" rel="noopener noreferrer">@webpack-dev-server/Server.js#L745<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>创建socket服务器，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/servers/SockJSServer.js#L34" target="_blank" rel="noopener noreferrer">@webpack-dev-server/SockJSServer.js#L34<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h3 id="服务端简易实现"><a href="#服务端简易实现" class="header-anchor">#</a> 服务端简易实现</h3> <h4 id="启动webpack-dev-server服务器"><a href="#启动webpack-dev-server服务器" class="header-anchor">#</a> 启动webpack-dev-server服务器</h4> <p>先导入所有依赖</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span> <span class="token comment">// 解析文件路径</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span> <span class="token comment">// 启动本地服务</span>
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span> <span class="token comment">// 获取文件类型 实现一个静态服务器</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span> <span class="token comment">// 读取配置文件进行打包</span>
<span class="token keyword">const</span> MemoryFileSystem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'memory-fs'</span><span class="token punctuation">)</span> <span class="token comment">// 使用内存文件系统更快，文件生成在内存中而非真实文件</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span> <span class="token comment">// 获取webpack配置文件</span>
</code></pre></div><h4 id="创建webpack实例"><a href="#创建webpack实例" class="header-anchor">#</a> 创建webpack实例</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>compiler代表整个webpack编译任务，全局只有一个</p> <h4 id="创建server服务器"><a href="#创建server服务器" class="header-anchor">#</a> 创建Server服务器</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler
  <span class="token punctuation">}</span>
  <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器已经在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口上启动了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>实际中是使用express作为HTTP服务器的</p> <h4 id="添加webpack的done事件回调"><a href="#添加webpack的done事件回调" class="header-anchor">#</a> 添加webpack的done事件回调</h4> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sockets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> lasthash
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      lasthash <span class="token operator">=</span> stats<span class="token punctuation">.</span>hash
      <span class="token comment">// 每当新一个编译完成后都会向客户端发送消息</span>
      sockets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">socket</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// 先向客户端发送最新的hash值</span>
        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span> <span class="token comment">// 再向客户端发送一个ok</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>webpack</code>编译后提供提供了一系列钩子函数，以供插件能访问到它的各个生命周期节点，并对其打包内容做修改。<code>compiler.hooks.done</code>则是插件能修改其内容的最后一个节点。</p> <p>编译完成通过<code>socket</code>向客户端发送消息，推送每次编译产生的<code>hash</code>。另外如果是热更新的话，还会产出两个补丁文件，里面描述了从上一次结果到这一次结果都有哪些chunk和模块发生了变化。</p> <p>使用<code>let sockets = []</code>数组去存放当打开了多个Tab时每个Tab的<code>socket实例</code>。</p> <h4 id="创建express应用app"><a href="#创建express应用app" class="header-anchor">#</a> 创建express应用app</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="设置文件系统为内存文件系统"><a href="#设置文件系统为内存文件系统" class="header-anchor">#</a> 设置文件系统为内存文件系统</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>使用<code>MemoryFileSystem</code>将<code>compiler</code>的产出文件打包到内存中。</p> <h4 id="添加webpack-dev-middleware中间件"><a href="#添加webpack-dev-middleware中间件" class="header-anchor">#</a> 添加webpack-dev-middleware中间件</h4> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/favicon.ico'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// /index.html   dist/index.html</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> stat <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 判断是否存在这个文件,如果在的话直接把这个读出来发给浏览器</span>
      <span class="token keyword">let</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
      <span class="token keyword">let</span> contentType <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> res<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> <span class="token number">200</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span>
</code></pre></div><p>使用express启动了本地开发服务后，使用了内存文件系统，使读取文件后存放到内存中，提高读写效率，最终返回生成的文件。</p> <h4 id="启动webpack编译"><a href="#启动webpack编译" class="header-anchor">#</a> 启动webpack编译</h4> <div class="language-js extra-class"><pre class="language-js"><code>  compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'又一次编译任务成功完成了'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以监控的模式启动一次webpack编译，当编译成功之后执行回调</p> <h4 id="创建http服务器并启动服务"><a href="#创建http服务器并启动服务" class="header-anchor">#</a> 创建HTTP服务器并启动服务</h4> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">port</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器已经在</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">端口上启动了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="使用sockjs在浏览器端和服务端之间建立一个-websocket-长连接"><a href="#使用sockjs在浏览器端和服务端之间建立一个-websocket-长连接" class="header-anchor">#</a> 使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接</h4> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">let</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sockets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">,</span> lastHash<span class="token punctuation">)</span>
      socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>启动一个 websocket服务器，然后等待连接，连接到来之后存进sockets池;</p> <p>当有文件改动，webpack重新编译时，向客户端推送<code>hash</code>和<code>ok</code>两个事件
。</p> <h2 id="客户端实现细节"><a href="#客户端实现细节" class="header-anchor">#</a> 客户端实现细节</h2> <p>下面步骤主要是debug客户端源码分析其详细思路，也给出了代码所处的具体位置，感兴趣的可以先行定位到下面的代码处设置断点，然后观察数据的变化情况。也可以先跳过阅读此步骤。</p> <ol><li>webpack-dev-server/client端会监听到此hash消息，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js#L54" target="_blank" rel="noopener noreferrer">@webpack-dev-server/index.js#L54<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>客户端收到ok的消息后会执行reloadApp方法进行更新，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js#L101" target="_blank" rel="noopener noreferrer">index.js#L101<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>在reloadApp中会进行判断，是否支持热更新，如果支持的话发射webpackHotUpdate事件，如果不支持则直接刷新浏览器，源代码地址<a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/utils/reloadApp.js#L7" target="_blank" rel="noopener noreferrer">reloadApp.js#L7<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>在webpack/hot/dev-server.js会监听webpackHotUpdate事件，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js#L55" target="_blank" rel="noopener noreferrer">dev-server.js#L55<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>在check方法里会调用module.hot.check方法，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js#L13" target="_blank" rel="noopener noreferrer">dev-server.js#L13<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>HotModuleReplacement.runtime请求Manifest，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L180" target="_blank" rel="noopener noreferrer">HotModuleReplacement.runtime.js#L180<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>它通过调用 JsonpMainTemplate.runtime的hotDownloadManifest方法，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L23" target="_blank" rel="noopener noreferrer">JsonpMainTemplate.runtime.js#L23<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>调用JsonpMainTemplate.runtime的hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L14" target="_blank" rel="noopener noreferrer">JsonpMainTemplate.runtime.js#L14<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>补丁JS取回来后会调用JsonpMainTemplate.runtime.js的webpackHotUpdate方法，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L8" target="_blank" rel="noopener noreferrer">JsonpMainTemplate.runtime.js#L8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>然后会调用HotModuleReplacement.runtime.js的hotAddUpdateChunk方法动态更新模块代码，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L222" target="_blank" rel="noopener noreferrer">HotModuleReplacement.runtime.js#L222<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>然后调用hotApply方法进行热更新，源代码地址<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L257" target="_blank" rel="noopener noreferrer">HotModuleReplacement.runtime.js#L257<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L278" target="_blank" rel="noopener noreferrer">HotModuleReplacement.runtime.js#L278<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h3 id="客户端简易实现"><a href="#客户端简易实现" class="header-anchor">#</a> 客户端简易实现</h3> <h4 id="webpack-dev-server-client端会监听到此hash消息"><a href="#webpack-dev-server-client端会监听到此hash消息" class="header-anchor">#</a> webpack-dev-server/client端会监听到此hash消息</h4> <p>在开发客户端功能之前，需要在<code>src/index.html</code>中引入<code>socket.io</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/socket.io/socket.io.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>下面连接socket并接受消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> onConnected<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">onConnected</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'客户端连接成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> hotCurrentHash<span class="token punctuation">;</span> <span class="token comment">// lastHash 上一次 hash值 </span>
<span class="token keyword">let</span> currentHash<span class="token punctuation">;</span> <span class="token comment">// 这一次的hash值</span>
socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>将服务端webpack每次编译所产生<code>hash</code>进行缓存</p> <h4 id="客户端收到ok的消息后会执行reloadapp方法进行更新"><a href="#客户端收到ok的消息后会执行reloadapp方法进行更新" class="header-anchor">#</a> 客户端收到ok的消息后会执行reloadApp方法进行更新</h4> <div class="language-js extra-class"><pre class="language-js"><code>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="reloadapp中判断是否支持热更新"><a href="#reloadapp中判断是否支持热更新" class="header-anchor">#</a> reloadApp中判断是否支持热更新</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当收到ok事件后，会重新刷新app</span>
<span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token parameter">hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果hot为true 走热更新的逻辑</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'webpackHotUpdate'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果不支持热更新，则直接重新加载</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在reloadApp中会进行判断，是否支持热更新，如果支持的话发射(emit)webpackHotUpdate事件，如果不支持则直接刷新浏览器。</p> <h4 id="在webpack-hot-dev-server-js会监听webpackhotupdate事件"><a href="#在webpack-hot-dev-server-js会监听webpackhotupdate事件" class="header-anchor">#</a> 在webpack/hot/dev-server.js会监听webpackHotUpdate事件</h4> <p>首先需要一个发布订阅去绑定事件并在合适的时机触发。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> listener
  <span class="token punctuation">}</span>
  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listeners<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> hotEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Emitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'webpackHotUpdate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hotCurrentHash <span class="token operator">||</span> hotCurrentHash <span class="token operator">==</span> currentHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> hotCurrentHash <span class="token operator">=</span> currentHash
  <span class="token punctuation">}</span>
  <span class="token function">hotCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>会判断是否为第一次进入页面和代码是否有更新。</p> <h4 id="在check方法里会调用module-hot-check方法"><a href="#在check方法里会调用module-hot-check方法" class="header-anchor">#</a> 在check方法里会调用module.hot.check方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hotCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">hotDownloadManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">update</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunkIds <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>c<span class="token punctuation">)</span>
    chunkIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面也提到过webpack每次编译都会产生<code>hash值</code>、<code>已改动模块的json文件</code>、<code>已改动模块代码的js文件</code>，</p> <p>此时先使用<code>ajax</code>请求<code>Manifest</code>即服务器这一次编译相对于上一次编译改变了哪些module和chunk。</p> <p>然后再通过<code>jsonp</code>获取这些已改动的module和chunk的代码。</p> <h4 id="调用hotdownloadmanifest方法"><a href="#调用hotdownloadmanifest方法" class="header-anchor">#</a> 调用hotDownloadManifest方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hotDownloadManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//hot-update.json文件里存放着从上一次编译到这一次编译 取到差异</span>
    <span class="token keyword">let</span> requestPath <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> hotCurrentHash <span class="token operator">+</span> <span class="token string">&quot;.hot-update.json&quot;</span>
    request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> requestPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> update <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="调用hotdownloadupdatechunk方法通过jsonp请求获取到最新的模块代码"><a href="#调用hotdownloadupdatechunk方法通过jsonp请求获取到最新的模块代码" class="header-anchor">#</a> 调用hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">'utf-8'</span>
  <span class="token comment">// /main.xxxx.hot-update.js</span>
  script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> hotCurrentHash <span class="token operator">+</span> <span class="token string">&quot;.hot-update.js&quot;</span>
  document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里解释下为什么使用<code>JSONP</code>获取而不直接利用<code>socket</code>获取最新代码？主要是因为<code>JSONP</code>获取的代码可以直接执行。</p> <h4 id="调用webpackhotupdate方法"><a href="#调用webpackhotupdate方法" class="header-anchor">#</a> 调用webpackHotUpdate方法</h4> <p>当客户端把最新的代码拉到浏览之后</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">webpackHotUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 循环新拉来的模块</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从模块缓存中取到老的模块定义</span>
    <span class="token keyword">let</span> oldModule <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span>
    <span class="token comment">// parents哪些模块引用这个模块 children这个模块引用了哪些模块</span>
    <span class="token comment">// parents=['./src/index.js']</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>
      parents<span class="token punctuation">,</span>
      children
    <span class="token punctuation">}</span> <span class="token operator">=</span> oldModule
    <span class="token comment">// 更新缓存为最新代码 缓存进行更新</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">i</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
      <span class="token literal-property property">l</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      parents<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
      <span class="token literal-property property">hot</span><span class="token operator">:</span> window<span class="token punctuation">.</span><span class="token function">hotCreateModule</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span>
    module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 状态变为加载就是给module.exports 赋值了</span>
    parents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">parent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// parents=['./src/index.js']</span>
      <span class="token keyword">let</span> parentModule <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>parent<span class="token punctuation">]</span>
      <span class="token comment">// _acceptedDependencies={'./src/title.js',render}</span>
      parentModule <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    hotCurrentHash <span class="token operator">=</span> currentHash
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="hotcreatemodule的实现"><a href="#hotcreatemodule的实现" class="header-anchor">#</a> hotCreateModule的实现</h4> <p>实现我们可以在业务代码中定义需要热更新的模块以及回调函数，将其存放在<code>hot._acceptedDependencies</code>中。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">hotCreateModule</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">_acceptedDependencies</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 销毁老的元素</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">accept</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// hot._acceptedDependencies={'./title': render}</span>
        hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> callback
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> hot
<span class="token punctuation">}</span>
</code></pre></div><p>然后在<code>webpackHotUpdate</code>中进行调用</p> <div class="language-js extra-class"><pre class="language-js"><code>    parents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">parent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// parents=['./src/index.js']</span>
      <span class="token keyword">let</span> parentModule <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>parent<span class="token punctuation">]</span>
      <span class="token comment">// _acceptedDependencies={'./src/title.js',render}</span>
      parentModule <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>最后调用hotApply方法进行热更新</p> <h2 id="vite中的hmr"><a href="#vite中的hmr" class="header-anchor">#</a> Vite中的HMR</h2> <p>以下内容引用自Vite官网</p> <blockquote><p>基于打包器启动时，重建整个包的效率很低。原因显而易见：因为这样更新速度会随着应用体积增长而直线下降。<br> <br>
一些打包器的开发服务器将构建内容存入内存，这样它们只需要在文件更改时使模块图的一部分失活，但它也仍需要整个重新构建并重载页面。这样代价很高，并且重新加载页面会消除应用的当前状态，所以打包器支持了动态模块热重载（HMR）：允许一个模块 “热替换” 它自己，而不会影响页面其余部分。这大大改进了开发体验 —— 然而，在实践中我们发现，即使采用了 HMR 模式，其热更新速度也会随着应用规模的增长而显著下降。<br> <br>
在 Vite 中，HMR 是在原生 ESM 上执行的。当编辑一个文件时，Vite 只需要精确地使已编辑的模块与其最近的 HMR 边界之间的链失活（大多数时候只是模块本身），使得无论应用大小如何，HMR 始终能保持快速更新。<br> <br>
Vite 同时利用 HTTP 头来加速整个页面的重新加载（再次让浏览器为我们做更多事情）：源码模块的请求会根据 304 Not Modified 进行协商缓存，而依赖模块请求则会通过 Cache-Control: max-age=31536000,immutable 进行强缓存，因此一旦被缓存它们将不需要再次请求。</p></blockquote> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ul><li>webpack实现流程以及各个生命周期的作用是什么？</li></ul> <blockquote><p>webpack主要借助了<code>tapable</code>这个库所提供的一系列同步/异步钩子函数贯穿整个生命周期。</p></blockquote> <ul><li>为什么使用JSONP而不用socket通信获取更新过的代码？</li></ul> <blockquote><p>因为通过socket通信获取的是一串字符串需要再做处理。而通过<code>JSONP</code>获取的代码可以直接执行。</p></blockquote></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/galaxynova1999/final-frontier/edit/master/docs/article/engineering/todo/webpack-hmr.md" target="_blank" rel="noopener noreferrer">内容有误？编辑此文章</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/19/2021, 2:38:01 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/final-frontier/assets/js/app.f9e97b58.js" defer></script><script src="/final-frontier/assets/js/2.b4be2d04.js" defer></script><script src="/final-frontier/assets/js/9.3fb29486.js" defer></script>
  </body>
</html>
