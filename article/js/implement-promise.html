<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实现一个 Promise | Final-Frontier</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/final-frontier/assets/css/0.styles.850a3e21.css" as="style"><link rel="preload" href="/final-frontier/assets/js/app.f9e97b58.js" as="script"><link rel="preload" href="/final-frontier/assets/js/2.b4be2d04.js" as="script"><link rel="preload" href="/final-frontier/assets/js/153.e34ca29d.js" as="script"><link rel="prefetch" href="/final-frontier/assets/js/10.f2cddb15.js"><link rel="prefetch" href="/final-frontier/assets/js/100.e4731769.js"><link rel="prefetch" href="/final-frontier/assets/js/101.78cba9e0.js"><link rel="prefetch" href="/final-frontier/assets/js/102.d59121ac.js"><link rel="prefetch" href="/final-frontier/assets/js/103.02f81555.js"><link rel="prefetch" href="/final-frontier/assets/js/104.035808e0.js"><link rel="prefetch" href="/final-frontier/assets/js/105.0d0355e5.js"><link rel="prefetch" href="/final-frontier/assets/js/106.45e731ce.js"><link rel="prefetch" href="/final-frontier/assets/js/107.48dd8215.js"><link rel="prefetch" href="/final-frontier/assets/js/108.43b0c535.js"><link rel="prefetch" href="/final-frontier/assets/js/109.b85a4723.js"><link rel="prefetch" href="/final-frontier/assets/js/11.eedec520.js"><link rel="prefetch" href="/final-frontier/assets/js/110.06b6c2c4.js"><link rel="prefetch" href="/final-frontier/assets/js/111.a1f96c71.js"><link rel="prefetch" href="/final-frontier/assets/js/112.8d818d3d.js"><link rel="prefetch" href="/final-frontier/assets/js/113.489f2816.js"><link rel="prefetch" href="/final-frontier/assets/js/114.005d05ff.js"><link rel="prefetch" href="/final-frontier/assets/js/115.7d0940cb.js"><link rel="prefetch" href="/final-frontier/assets/js/116.66d3013d.js"><link rel="prefetch" href="/final-frontier/assets/js/117.e50f9939.js"><link rel="prefetch" href="/final-frontier/assets/js/118.24154638.js"><link rel="prefetch" href="/final-frontier/assets/js/119.c74b3be1.js"><link rel="prefetch" href="/final-frontier/assets/js/12.4317ec11.js"><link rel="prefetch" href="/final-frontier/assets/js/120.5da2342c.js"><link rel="prefetch" href="/final-frontier/assets/js/121.931dba27.js"><link rel="prefetch" href="/final-frontier/assets/js/122.3e61d86a.js"><link rel="prefetch" href="/final-frontier/assets/js/123.a73c06d0.js"><link rel="prefetch" href="/final-frontier/assets/js/124.f38644ba.js"><link rel="prefetch" href="/final-frontier/assets/js/125.d349b0eb.js"><link rel="prefetch" href="/final-frontier/assets/js/126.37600dd5.js"><link rel="prefetch" href="/final-frontier/assets/js/127.7867b78d.js"><link rel="prefetch" href="/final-frontier/assets/js/128.d25e3580.js"><link rel="prefetch" href="/final-frontier/assets/js/129.2a34bed2.js"><link rel="prefetch" href="/final-frontier/assets/js/13.b38bf636.js"><link rel="prefetch" href="/final-frontier/assets/js/130.bcb7b154.js"><link rel="prefetch" href="/final-frontier/assets/js/131.6695048b.js"><link rel="prefetch" href="/final-frontier/assets/js/132.4c59c0d0.js"><link rel="prefetch" href="/final-frontier/assets/js/133.eb3a3330.js"><link rel="prefetch" href="/final-frontier/assets/js/134.59324c5b.js"><link rel="prefetch" href="/final-frontier/assets/js/135.f24f365a.js"><link rel="prefetch" href="/final-frontier/assets/js/136.0b6132bb.js"><link rel="prefetch" href="/final-frontier/assets/js/137.d4e6ae33.js"><link rel="prefetch" href="/final-frontier/assets/js/138.468881cf.js"><link rel="prefetch" href="/final-frontier/assets/js/139.bc47b208.js"><link rel="prefetch" href="/final-frontier/assets/js/14.c582bb27.js"><link rel="prefetch" href="/final-frontier/assets/js/140.06de75d6.js"><link rel="prefetch" href="/final-frontier/assets/js/141.27e6a871.js"><link rel="prefetch" href="/final-frontier/assets/js/142.d4cbec9d.js"><link rel="prefetch" href="/final-frontier/assets/js/143.80d1f094.js"><link rel="prefetch" href="/final-frontier/assets/js/144.42884138.js"><link rel="prefetch" href="/final-frontier/assets/js/145.3d28f7bf.js"><link rel="prefetch" href="/final-frontier/assets/js/146.956955df.js"><link rel="prefetch" href="/final-frontier/assets/js/147.5dcd9c08.js"><link rel="prefetch" href="/final-frontier/assets/js/148.8b882ec0.js"><link rel="prefetch" href="/final-frontier/assets/js/149.d272ab0e.js"><link rel="prefetch" href="/final-frontier/assets/js/15.330b31b0.js"><link rel="prefetch" href="/final-frontier/assets/js/150.15ab6dea.js"><link rel="prefetch" href="/final-frontier/assets/js/151.0c105344.js"><link rel="prefetch" href="/final-frontier/assets/js/152.c2cd9d79.js"><link rel="prefetch" href="/final-frontier/assets/js/154.fcd3a9d8.js"><link rel="prefetch" href="/final-frontier/assets/js/155.58105e90.js"><link rel="prefetch" href="/final-frontier/assets/js/156.aeb03519.js"><link rel="prefetch" href="/final-frontier/assets/js/157.b0ccce6e.js"><link rel="prefetch" href="/final-frontier/assets/js/158.bec5b99a.js"><link rel="prefetch" href="/final-frontier/assets/js/159.e81bab43.js"><link rel="prefetch" href="/final-frontier/assets/js/16.4d098475.js"><link rel="prefetch" href="/final-frontier/assets/js/160.02c170a3.js"><link rel="prefetch" href="/final-frontier/assets/js/161.02928332.js"><link rel="prefetch" href="/final-frontier/assets/js/162.52952c0e.js"><link rel="prefetch" href="/final-frontier/assets/js/163.f107f5b9.js"><link rel="prefetch" href="/final-frontier/assets/js/164.4c8ec94f.js"><link rel="prefetch" href="/final-frontier/assets/js/165.fe3f3e38.js"><link rel="prefetch" href="/final-frontier/assets/js/166.bfd94322.js"><link rel="prefetch" href="/final-frontier/assets/js/167.2b012733.js"><link rel="prefetch" href="/final-frontier/assets/js/168.4620404b.js"><link rel="prefetch" href="/final-frontier/assets/js/169.9c928ecb.js"><link rel="prefetch" href="/final-frontier/assets/js/17.65263330.js"><link rel="prefetch" href="/final-frontier/assets/js/170.9df651d4.js"><link rel="prefetch" href="/final-frontier/assets/js/18.b27e1f22.js"><link rel="prefetch" href="/final-frontier/assets/js/19.1ee342e5.js"><link rel="prefetch" href="/final-frontier/assets/js/20.823c015f.js"><link rel="prefetch" href="/final-frontier/assets/js/21.44689c5c.js"><link rel="prefetch" href="/final-frontier/assets/js/22.d030504c.js"><link rel="prefetch" href="/final-frontier/assets/js/23.ebb1757e.js"><link rel="prefetch" href="/final-frontier/assets/js/24.da0e3906.js"><link rel="prefetch" href="/final-frontier/assets/js/25.6ef453f7.js"><link rel="prefetch" href="/final-frontier/assets/js/26.1d8e80db.js"><link rel="prefetch" href="/final-frontier/assets/js/27.5f9099ad.js"><link rel="prefetch" href="/final-frontier/assets/js/28.0a85d87c.js"><link rel="prefetch" href="/final-frontier/assets/js/29.93858a71.js"><link rel="prefetch" href="/final-frontier/assets/js/3.e184c9a6.js"><link rel="prefetch" href="/final-frontier/assets/js/30.b00438fd.js"><link rel="prefetch" href="/final-frontier/assets/js/31.3c252603.js"><link rel="prefetch" href="/final-frontier/assets/js/32.68354049.js"><link rel="prefetch" href="/final-frontier/assets/js/33.edf9c033.js"><link rel="prefetch" href="/final-frontier/assets/js/34.a457093b.js"><link rel="prefetch" href="/final-frontier/assets/js/35.39acde3d.js"><link rel="prefetch" href="/final-frontier/assets/js/36.dc8d1a55.js"><link rel="prefetch" href="/final-frontier/assets/js/37.7f171371.js"><link rel="prefetch" href="/final-frontier/assets/js/38.e98d1f3a.js"><link rel="prefetch" href="/final-frontier/assets/js/39.4e54cadb.js"><link rel="prefetch" href="/final-frontier/assets/js/4.c6e69f90.js"><link rel="prefetch" href="/final-frontier/assets/js/40.573fbcba.js"><link rel="prefetch" href="/final-frontier/assets/js/41.20af0cb8.js"><link rel="prefetch" href="/final-frontier/assets/js/42.733c8990.js"><link rel="prefetch" href="/final-frontier/assets/js/43.32a46e23.js"><link rel="prefetch" href="/final-frontier/assets/js/44.4281f6ab.js"><link rel="prefetch" href="/final-frontier/assets/js/45.d5d2942f.js"><link rel="prefetch" href="/final-frontier/assets/js/46.fc9e248d.js"><link rel="prefetch" href="/final-frontier/assets/js/47.bc3e46b1.js"><link rel="prefetch" href="/final-frontier/assets/js/48.7f953d4b.js"><link rel="prefetch" href="/final-frontier/assets/js/49.c882d8d3.js"><link rel="prefetch" href="/final-frontier/assets/js/5.f65c0638.js"><link rel="prefetch" href="/final-frontier/assets/js/50.79b01142.js"><link rel="prefetch" href="/final-frontier/assets/js/51.4eb54394.js"><link rel="prefetch" href="/final-frontier/assets/js/52.78f38161.js"><link rel="prefetch" href="/final-frontier/assets/js/53.d9389fdd.js"><link rel="prefetch" href="/final-frontier/assets/js/54.d45e0f4d.js"><link rel="prefetch" href="/final-frontier/assets/js/55.9afe2316.js"><link rel="prefetch" href="/final-frontier/assets/js/56.14719107.js"><link rel="prefetch" href="/final-frontier/assets/js/57.585a0866.js"><link rel="prefetch" href="/final-frontier/assets/js/58.5530bfeb.js"><link rel="prefetch" href="/final-frontier/assets/js/59.7f433e63.js"><link rel="prefetch" href="/final-frontier/assets/js/6.4a41c59e.js"><link rel="prefetch" href="/final-frontier/assets/js/60.1e44d3c6.js"><link rel="prefetch" href="/final-frontier/assets/js/61.cdf1979f.js"><link rel="prefetch" href="/final-frontier/assets/js/62.744fc902.js"><link rel="prefetch" href="/final-frontier/assets/js/63.35920e83.js"><link rel="prefetch" href="/final-frontier/assets/js/64.cc6f3dc2.js"><link rel="prefetch" href="/final-frontier/assets/js/65.14df1fc8.js"><link rel="prefetch" href="/final-frontier/assets/js/66.936a2159.js"><link rel="prefetch" href="/final-frontier/assets/js/67.1308bd29.js"><link rel="prefetch" href="/final-frontier/assets/js/68.475e96a8.js"><link rel="prefetch" href="/final-frontier/assets/js/69.74434bff.js"><link rel="prefetch" href="/final-frontier/assets/js/7.784a80c1.js"><link rel="prefetch" href="/final-frontier/assets/js/70.822ecc05.js"><link rel="prefetch" href="/final-frontier/assets/js/71.9c374dcb.js"><link rel="prefetch" href="/final-frontier/assets/js/72.1f0842c9.js"><link rel="prefetch" href="/final-frontier/assets/js/73.8bbca6c1.js"><link rel="prefetch" href="/final-frontier/assets/js/74.17fd08b7.js"><link rel="prefetch" href="/final-frontier/assets/js/75.e39ed91c.js"><link rel="prefetch" href="/final-frontier/assets/js/76.4001f797.js"><link rel="prefetch" href="/final-frontier/assets/js/77.9e146f0f.js"><link rel="prefetch" href="/final-frontier/assets/js/78.77f819d1.js"><link rel="prefetch" href="/final-frontier/assets/js/79.f374ec2e.js"><link rel="prefetch" href="/final-frontier/assets/js/8.c38ccaff.js"><link rel="prefetch" href="/final-frontier/assets/js/80.cb5fd22c.js"><link rel="prefetch" href="/final-frontier/assets/js/81.58ced288.js"><link rel="prefetch" href="/final-frontier/assets/js/82.2a0c8dd8.js"><link rel="prefetch" href="/final-frontier/assets/js/83.62e28c48.js"><link rel="prefetch" href="/final-frontier/assets/js/84.1ffe1d78.js"><link rel="prefetch" href="/final-frontier/assets/js/85.b4311925.js"><link rel="prefetch" href="/final-frontier/assets/js/86.6c39539a.js"><link rel="prefetch" href="/final-frontier/assets/js/87.74481597.js"><link rel="prefetch" href="/final-frontier/assets/js/88.1260b237.js"><link rel="prefetch" href="/final-frontier/assets/js/89.5d5f16bc.js"><link rel="prefetch" href="/final-frontier/assets/js/9.3fb29486.js"><link rel="prefetch" href="/final-frontier/assets/js/90.602550f2.js"><link rel="prefetch" href="/final-frontier/assets/js/91.9b50d9db.js"><link rel="prefetch" href="/final-frontier/assets/js/92.9aa7bfa4.js"><link rel="prefetch" href="/final-frontier/assets/js/93.0e8e6805.js"><link rel="prefetch" href="/final-frontier/assets/js/94.bfb47c06.js"><link rel="prefetch" href="/final-frontier/assets/js/95.b5b1f0d3.js"><link rel="prefetch" href="/final-frontier/assets/js/96.6305c39b.js"><link rel="prefetch" href="/final-frontier/assets/js/97.0bd16536.js"><link rel="prefetch" href="/final-frontier/assets/js/98.7da6c33c.js"><link rel="prefetch" href="/final-frontier/assets/js/99.fcdf9b89.js">
    <link rel="stylesheet" href="/final-frontier/assets/css/0.styles.850a3e21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/final-frontier/" class="home-link router-link-active"><img src="/final-frontier/favicon.png" alt="Final-Frontier" class="logo"> <span class="site-name can-hide">Final-Frontier</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/final-frontier/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/final-frontier/article/framework/angular-di.html" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="/final-frontier/basic/js/implement-tool-func.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><a href="/final-frontier/algorithm/leetcode/add-two-numbers.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/final-frontier/notes/professional-js-for-web-developers/type-conversion.html" class="nav-link">
  读书笔记
</a></div> <a href="https://github.com/galaxynova1999/final-frontier" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/final-frontier/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/final-frontier/article/framework/angular-di.html" class="nav-link">
  博文
</a></div><div class="nav-item"><a href="/final-frontier/basic/js/implement-tool-func.html" class="nav-link">
  基础知识
</a></div><div class="nav-item"><a href="/final-frontier/algorithm/leetcode/add-two-numbers.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/final-frontier/notes/professional-js-for-web-developers/type-conversion.html" class="nav-link">
  读书笔记
</a></div> <a href="https://github.com/galaxynova1999/final-frontier" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端框架 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/framework/angular-di.html" class="sidebar-link">Angular中的DI</a></li><li><a href="/final-frontier/article/framework/react-performance.html" class="sidebar-link">React性能优化的一点看法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JS &amp; TS (5)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/js/arrow-function.html" class="sidebar-link">箭头函数和普通函数的区别</a></li><li><a href="/final-frontier/article/js/does-js-need-semicolon.html" class="sidebar-link">JS 需要使用分号吗?</a></li><li><a href="/final-frontier/article/js/implement-promise.html" aria-current="page" class="active sidebar-link">实现一个 Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/final-frontier/article/js/implement-promise.html#什么是promise-a-规范" class="sidebar-link">什么是Promise A+ 规范</a></li><li class="sidebar-sub-header"><a href="/final-frontier/article/js/implement-promise.html#核心点" class="sidebar-link">核心点</a></li><li class="sidebar-sub-header"><a href="/final-frontier/article/js/implement-promise.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li><li><a href="/final-frontier/article/js/mutex-atomics.html" class="sidebar-link">使用 Atomics API 实现互斥锁</a></li><li><a href="/final-frontier/article/js/nullish-coalescing-operator.html" class="sidebar-link">空值合并运算符</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程化 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/engineering/tsconfig.html" class="sidebar-link">tsconfig 文件配置</a></li><li><a href="/final-frontier/article/engineering/webpack-config.html" class="sidebar-link">Webpack 基本配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术扩展 (3)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/tech/bitmask.html" class="sidebar-link">位掩码</a></li><li><a href="/final-frontier/article/tech/nrt-yata.html" class="sidebar-link">协同编辑-YATA算法</a></li><li><a href="/final-frontier/article/tech/swagger-ts.html" class="sidebar-link">Swagger 生成 TS 定义文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器 (2)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/final-frontier/article/browser/browser-cache.html" class="sidebar-link">浅谈浏览器缓存</a></li><li><a href="/final-frontier/article/browser/browser-navigation-timing.html" class="sidebar-link">浏览器Navigation Timing API</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="什么是promise-a-规范"><a href="#什么是promise-a-规范" class="header-anchor">#</a> 什么是Promise A+ 规范</h2> <p>Promise A+规范是由Promises/A+ organization提出的一个Promise then方法的实现标准，需要注意的是，这份标准并未对如何创建、resolve、reject Promise做出规定</p> <h3 id="_1-术语和概念"><a href="#_1-术语和概念" class="header-anchor">#</a> 1. 术语和概念</h3> <table><thead><tr><th>名词</th> <th>含义</th></tr></thead> <tbody><tr><td>promise</td> <td>promise指一个拥有then方法的对象或函数, 且then方法的功能和表现与本规范一致</td></tr> <tr><td>thenable</td> <td>一个定义了then方法的对象或函数</td></tr> <tr><td>value</td> <td>是一个任何可能的JS值，包括但不限于undefined, thenable,以及promise</td></tr> <tr><td>exception</td> <td>指一个被throw语句抛出的值(value)</td></tr> <tr><td>reason</td> <td>指一个值(value) 这个值指明了为什么一个promise状态变为了rejected</td></tr></tbody></table> <h3 id="_2-规范要求"><a href="#_2-规范要求" class="header-anchor">#</a> 2. 规范要求</h3> <ul><li>2.1  Promise的三种状态
一个promise总是且仅可能处于以下三种状态中的一种：<code>pending</code>, <code>fulfilled</code>, 或<code>rejected</code> <ul><li>2.1.1 当一个promise处于<code>pending</code>状态时，可以转变为<code>fulfilled</code>状态或<code>rejected</code>状态</li> <li>2.1.2 当一个promise处于<code>fulfilled</code>状态时，状态不能再发生任何改变，且必须拥有一个不可变的<code>value</code></li> <li>2.1.3 当一个promise处于<code>rejected</code>状态时，状态不能再发生任何改变，且必须拥有一个不可变的<code>reason</code></li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>不可变的标准是使用 === 判断的结果为true， 但对于对象、数组等引用类型的内容是否可以发生变化，标准并未说明
可以理解为一个使用const 声明的变量</p></div> <ul><li>2.2  then方法
一个promise必须提供一个then方法，使用此方法可以访问到它当前(promise已经resolve或rejected)或最终的(promise目前还在pending阶段)<code>value</code>或<code>reason</code>
then方法应接收两个参数，分别为<code>onFulfilled</code>, <code>onRejected</code></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
</code></pre></div><p>这两个参数都是可选参数(使用TS书写时，参数类型应该为any)，根据标准，当这两个参数不是函数的时候，必须被忽略</p> <ul><li>2.2.1 如果<code>onFulfilled</code>是一个函数
<ul><li><p>2.2.2.1 它必须在promise被<code>resolve</code>之后，也就是状态变为<code>fulfilled</code>之后调用，且promise的<code>value</code>将作为第一个参数传入<code>onFulfilled</code>中</p></li> <li><p>2.2.2.2 它绝对不能在promise被<code>resolve</code>之前调用</p></li></ul></li></ul> <ul><li>2.2.2.3 它绝对不能被调用超过一次</li></ul> <ul><li><p>2.2.3 <code>onRejected</code>情况类似 不再赘述</p></li> <li><p>2.2.4 <code>onFulfilled</code>和<code>onRejected</code>应该异步执行</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">原文如下</p> <p>onFulfilled or onRejected must not be called until the execution context stack contains only platform code</p></div> <ul><li><p>2.2.5 <code>onFulfilled</code>和<code>onRejected</code>必须作为函数被调用</p></li> <li><p>2.2.6 同一个promise的then函数可能且可以被调用多次</p> <ul><li>2.2.6.1 如果promise已经<code>resolve</code>或被<code>resolve</code>时，所有<code>onFulfilled</code>回调都必须按照其挂载顺序执行</li></ul></li> <li><p>2.2.7 then方法必须返回一个promise (注：标准并未说明要返回的promise是一个新的promise，所以简易版实现promise时，可以返回本身，但是目前主流的实现都是返回一个新的promise)</p></li></ul> <p>假设有</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>2.2.7.1 如果<code>onFulfilled</code>或<code>onRejected</code>返回了一个value = x, 执行<code>PRP(Promise Resolution Procedure)</code></li></ul> <ul><li>2.2.7.2如果<code>onFulfilled</code>或<code>onRejected</code>抛出了<code>exception = e</code>, promise2将是<code>rejected</code>状态，且<code>reason = e</code>;</li></ul> <ul><li>2.2.7.3 如果<code>onFulfilled</code>不是一个函数，但是promise1被<code>resolve</code>了，那么promise2也将以promise1 <code>resolve</code>的值<code>fulfilled</code>, 也就是<strong>值透传</strong>的问题（参考核心点2）</li></ul> <h3 id="promise-resolution-procedure"><a href="#promise-resolution-procedure" class="header-anchor">#</a> Promise Resolution Procedure</h3> <p>// to be done</p> <p>更多请参考 <a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promises/A+<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="核心点"><a href="#核心点" class="header-anchor">#</a> 核心点</h2> <ol><li><p>Promise的构造函数</p> <ul><li><p>参数必须是一个函数（入口处判断），函数应接收<code>resolve</code>和<code>reject</code>两个参数</p></li> <li><p>每个Promise构造函数内都应该包含两个独立的<code>resolve</code>和<code>reject</code>函数(可以声明在原型上，但是独立声明会更好)</p></li> <li><p><code>resolve</code>和<code>reject</code>被执行时应该放入微任务队列中执行，这是目前的主流实现,<br>
代码中我使用的是<code>queueMicroTask</code>这个比较的新的API，除此之外还可以使用<code>MutationObserver</code>和Node环境下的<code>process.nextTick</code></p> <p>需要注意的是在Promise A+标准中并没有规定then的执行必须是微任务，只要求是异步执行就可以</p> <div class="custom-block tip"><p class="custom-block-title">原文如下</p> <p>Here “platform code” means engine, environment, and promise implementation code.
In practice, this requirement ensures that onFulfilled and onRejected execute asynchronously, after the event loop turn in which then is called, and with a fresh stack.
This can be implemented with either a “macro-task” mechanism such as setTimeout or setImmediate, or with a “micro-task” mechanism such as MutationObserver or process.nextTick</p></div></li> <li><p>在<code>resolve</code>和<code>reject</code>函数执行之前需要判断当前状态是否为pending，是的话才能改变状态,此处体现的是Promise的状态一经变化就不能再改变</p></li> <li><p><code>resolve</code>函数和<code>reject</code>函数主要作用就是在遍历调用使用then注册的回调函数</p></li></ul></li> <li><p>then方法</p> <ul><li>then方法需要挂载在原型上，因为每个Promise对象都有then方法</li> <li>then方法接收两个函数参数，分别为<code>onFulfilled</code>和<code>onRejected</code>，如果这两个参数有任何一个不为函数，需要我们
手动生成一个临时函数，临时函数的作用就是把当前值传递下去, 解决下面这种<code>值透传</code>的问题(Promise A+标准)<div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'something'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li>then函数的主要执行逻辑是返回一个Promise, Promise内执行：
<ul><li>当前状态是<code>fulfilled</code>或<code>rejected</code>, 直接用<code>this.value</code>或<code>this.reason</code>去分别执行传入的两个回调，得到结果后
resolve返回的这个Promise</li> <li>当前状态是pending, 则我们不清楚这个Promise会resolve还是reject，所以我们需要把两个回调都存入到对应的回调数组中
存储起来，等待Promise状态改变再依次去执行回调</li></ul></li></ul></li> <li><p>catch方法<br>
catch方法本质上就是在调用then方法，把回调传入then的第二个参数，依状态执行或保存起来，无特殊含义。<br>
但是catch函数可以捕获之前then方法中抛出的错误，所以我们应该优先使用catch方法来捕获错误而不是then的第二个参数</p></li> <li><p>finally方法</p> <ul><li>finally方法也是在调用then方法，不同的是需要将finally回调同时存入then的两个参数，因为不清楚Promise的状态会如何变化
而finally方法无论什么情况总要被执行</li> <li>回调在执行时，需要先使用静态resolve方法转化finally回调的运行结果，然后再在then中<code>return</code>或者<code>throw</code>结果</li></ul></li> <li><p>静态all方法 - 返回Promise</p> <ul><li>all方法会等待一组Promise全部resolve然后以数组的方式返回值，或者是其中一个Promise reject之后reject整个Promise</li> <li>all方法在一般的实现中都默认传入一个数组，然后判断参数是不是数组来抛出错误入参
但是，根据目前浏览器ES6的实现，all方法可以接收一切部署了<code>Symbol.iterator</code>的数据结构，包括但不限于数组、Map、Set、TypedArray等
这些数据结构的特点是都可以使用统一的<code>for...of</code>语法来遍历</li> <li>需要注意的是，字符串也是一种可遍历的数据结构，如果是字符串，直接返回[[String]]</li> <li>使用一个数组来保存所有Promise的结果， 使用for循环加上let-i来把对应的resolve结果存到对应的位置上，
即：返回的数组里面的结果的顺序需要和传入的Promise的顺序相同</li> <li>每一个promise在被挂载then方法之前，都需要先调用静态resolve方法转化为Promise</li></ul></li> <li><p>静态race方法 - 返回Promise</p> <ul><li>race方法会在一组Promise中对比，有任意一个Promise发生状态改变，都会立即导致返回的Promise的状态变化</li> <li>接收的参数类型和all方法一致</li></ul></li> <li><p>静态resolve和reject方法</p> <ul><li>接收任意参数，返回一个fulfilled或rejected状态的Promise</li> <li>参数是一个Promise对象, 原封不动的返回原对象</li> <li>参数是一个thenable对象，即具有then方法的对象，调用他的then方法，向then方法中传入Promise内定义的resolve和reject两个方法</li> <li>其他情况 返回一个resolve或reject了参数的Promise</li></ul></li></ol> <h2 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h2> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> PromiseType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./data/PromiseType&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>getType<span class="token punctuation">,</span> isFunction<span class="token punctuation">,</span> isNullOrUndefined<span class="token punctuation">,</span> isObject<span class="token punctuation">,</span> isString<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token builtin">Promise</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> status<span class="token operator">:</span> PromiseType <span class="token operator">=</span> PromiseType<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">;</span> <span class="token comment">// 保存当前Promise的状态，初始状态为PENDING</span>
    <span class="token keyword">private</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// 保存供then函数接收的数据</span>
    <span class="token keyword">private</span> reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> <span class="token comment">// reject状态下返回的原因</span>

    <span class="token keyword">private</span> onFulfilledCallBack<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 添加到这个Promise的resolved回调</span>
    <span class="token keyword">private</span> onRejectedCallBack<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// rejected回调</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>asyncFunc<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>asyncFunc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'请传入一个函数来初始化Promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         *  每个Promise都有一对属于自己的resolve和rejected函数
         */</span>
        <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// then的两个参数需要异步执行</span>
          <span class="token comment">// 根据Promise A+标准 使用宏任务和微任务都可以</span>
          <span class="token comment">// 此处使用一个比较新的标准queueMicroTask来作为微任务执行，保持和当前浏览器环境一致</span>
          <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">// 此处判断体现了Promise的状态一经改变就不能再变化</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> PromiseType<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> PromiseType<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token punctuation">;</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallBack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callbackFunc <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                      <span class="token function">callbackFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token function-variable function">rejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">queueMicrotask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> PromiseType<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> PromiseType<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token punctuation">;</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
                  <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBack<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callbackFunc <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                      <span class="token function">callbackFunc</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">asyncFunc</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> rejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rejected</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token function">executeThen</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> executeFunc<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> fulFillRet <span class="token operator">=</span> <span class="token function">executeFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>fulFillRet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  1. then函数要返回一个新的Promise，便于链式调用
     */</span>
    <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> onRejected<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 根据Promise A+ 标准 需要做then-值穿透
         * 即: 如果没有传入onFulfilled或传入的不是一个函数
         * 需要自己生成一个函数用于把值传递下去，便于链式调用
         */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">onFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 此处使用throw 而不是return</span>
                <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 根据当前Promise状态来处理then调用
         */</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> PromiseType<span class="token punctuation">.</span><span class="token constant">FULFILLED</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">executeThen</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> onFulfilled<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> PromiseType<span class="token punctuation">.</span><span class="token constant">REJECTED</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">executeThen</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> onRejected<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> PromiseType<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallBack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">executeThen</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> onFulfilled<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallBack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">executeThen</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> onFulfilled<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * catch方法本质上是在调用then方法
     */</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">finally</span><span class="token punctuation">(</span>finalCallBack<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">finalCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">finalCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 参数为任何部署了Symbol.iterator的数据结构
     * 包括但不限于数组、Map、Set、TypedArray
     * 特殊情况: 字符串 字符串也是一种iterable的数据结构
     * @param promises
     */</span>
    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. null or undefined</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNullOrUndefined</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请传入一个合法的参数 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getType</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not iterable !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>
            <span class="token function">isObject</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">isFunction</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2. 如果是不合法的对象 抛出错误</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请传入一个合法的参数 object is not iterable !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// string直接返回</span>
            <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span>promises<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> promiseResponse <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存每个Promise的返回值</span>
        <span class="token keyword">let</span> resolveCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 记录已经Resolve的Promise数量</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 按顺序保存返回值</span>
                        promiseResponse<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>
                        resolveCount<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token comment">// 如果所有Promise都返回了 则resolve</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>resolveCount <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">resolve</span><span class="token punctuation">(</span>promiseResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 遇到reject的整个Promise都要reject</span>
                        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 防止对象的iterator函数不是一个合理的迭代器函数</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">TypeError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Result of the Symbol.iterator method is not an object'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. null or undefined</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNullOrUndefined</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请传入一个合法的参数 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getType</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not iterable !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>
            <span class="token function">isObject</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">isFunction</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2. 如果是不合法的对象 抛出错误</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请传入一个合法的参数 object is not iterable !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// string直接返回</span>
            <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token function">resolve</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 防止对象的iterator函数不是一个合理的迭代器函数</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">TypeError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Result of the Symbol.iterator method is not an object'</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 静态resolve方法 返回一个fulfilled状态的Promise
     * @param target
     */</span>
    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>target<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.情况一 参数是一个Promise对象, 原封不动的返回原对象</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> target<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.情况二 参数是一个thenable对象</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>then <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                target<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.情况三 参数不是thenable对象 或 根本不是对象</span>
        <span class="token comment">// 4.情况四 不带有参数</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/galaxynova1999/final-frontier/edit/master/docs/article/js/implement-promise.md" target="_blank" rel="noopener noreferrer">内容有误？编辑此文章</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/31/2021, 12:29:25 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/final-frontier/article/js/does-js-need-semicolon.html" class="prev">
        JS 需要使用分号吗?
      </a></span> <span class="next"><a href="/final-frontier/article/js/mutex-atomics.html">
        使用 Atomics API 实现互斥锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/final-frontier/assets/js/app.f9e97b58.js" defer></script><script src="/final-frontier/assets/js/2.b4be2d04.js" defer></script><script src="/final-frontier/assets/js/153.e34ca29d.js" defer></script>
  </body>
</html>
